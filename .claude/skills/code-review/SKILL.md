---
name: code-review
description: hometeプロジェクト用のiOS Swiftコードレビュースキル。SwiftLintを実行し、警告・エラーを報告し、git diffで変更されたSwiftファイルをレビューする。/code-reviewコマンドでユーザーがコードレビューを要求した時、または機能実装、リファクタリング、バグ修正、テスト更新後に使用。DIパターン準拠、Swift 6並行性、過度なエンジニアリングの回避、テストコードの品質に焦点を当てる。
---

# コードレビュー

SwiftLintの自動チェックと包括的なコード品質分析を備えた、homete iOSプロジェクト用のSwiftコードレビュースキル。

## ワークフロー

以下の手順を順番に実行する：

### 1. SwiftLintの実行

コードスタイルと品質をチェックするためSwiftLintを実行：

```bash
swift run --package-path ProjectTools swiftlint lint --config .swiftlint.yml
```

### 2. SwiftLint結果の報告

- 警告やエラーが存在する場合、ファイルパスと行番号を明確にリスト表示
- 重要度でグループ化（エラーを最初に、次に警告）
- エラーがある場合はコードレビューに進まず、ユーザーが修正する必要があることを伝える

### 3. 変更差分の取得

現在のブランチの派生元（分岐点）からの変更差分を取得：

```bash
git diff $(git merge-base main HEAD)..HEAD -- '*.swift'
```

ファイルが見つからない場合は、origin/mainとの差分を試す：

```bash
git diff $(git merge-base origin/main HEAD)..HEAD -- '*.swift'
```

### 4. 変更コードのレビュー

取得した差分を分析し、以下の基準でコードレビューを実施：

**レビュー方針**：
- 差分（追加・変更・削除された行）を中心にレビュー
- 新規ファイルの場合は全体の構造も確認
- 必要に応じて、文脈を理解するために関連ファイル全体をReadツールで読むこともある
- 差分が大きすぎる場合は、主要な変更箇所を優先してレビュー

#### 主要なレビュー基準

**Dependency Injection違反** (最優先)：
- ViewはServiceに直接アクセスしてはいけない - Clientを使用すべき
- Storeは初期化時に`AppDependencies`を受け取り、`.liveValue`または`.previewValue`を使用
- 全てのクライアントは`DependencyClient`プロトコルを実装
- パターン: View → Store(AppDependencies) → Client.liveValue → Service

**過度なエンジニアリング** (最優先)：
- 一度しか使わない処理のために不要な抽象化や汎用的なソリューションを避ける
- 要求された内容以外の機能を追加しない
- 発生し得ないシナリオのエラーハンドリングを追加しない
- 単一の操作のためにヘルパー/ユーティリティを作成しない
- 類似した3行のコード > 早すぎる抽象化

**テストコードの品質** (最優先)：
- 新機能には対応するユニットテストが必要
- UIコンポーネントにはスナップショットテスト（swift-snapshot-testing使用）が必要
- テストは日本語ロケール（`ja_JP`）と東京タイムゾーンを使用
- テストファイルは`hometeTests/`でメインアプリの構造をミラー

#### 副次的なレビュー基準

**Swift 6 Strict Concurrency**：
- UI関連コードに適切な`@MainActor`アノテーション
- アクター分離の準拠
- 並行性境界を越える型の`Sendable`準拠
- async/awaitを使用、completion handlerは使用しない

**セキュリティ問題**：
- ハードコードされたシークレットや認証情報がないこと
- システム境界での適切な入力検証
- クラッシュの可能性がある強制アンラップ（! 演算子）がないこと
- OWASP Top 10の一般的な脆弱性をチェック

**アーキテクチャ準拠**：
- クリーンアーキテクチャのレイヤーに従う（Views → Stores → Clients → Services → Domain）
- ドメインモデルは`homete/Model/Domain/`に配置
- サービスは`homete/Model/Service/`に配置
- Storeは`homete/Model/Store/`に配置

**コード品質**：
- ロジックが自明でない場合のみコメントを追加
- 変更していないコードにdocstringを追加しない
- 使用されていないコードに対する後方互換性のハックを避ける
- 使用されていないコードは完全に削除、コメントアウトしない

### 5. レビュー結果の出力

簡潔なサマリー形式を使用：

```markdown
## SwiftLint結果
[✓] エラーや警告なし
または
[⚠️] X個の警告、Y個のエラーを検出
- 各問題をファイル:行番号でリスト表示

## コードレビューサマリー
N個のファイル、M個の変更をレビュー

### 重大な問題
[DI違反、過度なエンジニアリング、テスト不足などをリスト表示]

### 提案
[軽微な改善点や懸念事項をリスト表示]

### 承認済み
[問題のないファイルをリスト表示]
```

## このスキルを使用しない場合

- コード構造に関する一般的な質問（代わりに探索を使用）
- Swiftファイルに変更がない場合
- 初期のコード探索や理解フェーズ中

## リファレンス

プロジェクトの詳細なアーキテクチャと規約については、以下を参照：
- `homete/CLAUDE.md` - プロジェクト概要とアーキテクチャパターン
- `.swiftlint.yml` - SwiftLint設定とルール
- `homete/Model/AppDependencies.swift` - DIコンテナ実装
